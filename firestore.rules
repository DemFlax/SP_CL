rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // HELPER FUNCTIONS
    // ==========================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isManager() {
      return isAuthenticated() && request.auth.token.role == 'manager';
    }
    
    function isGuide() {
      return isAuthenticated() && request.auth.token.role == 'guide';
    }
    
    // ==========================================
    // GUIDES COLLECTION
    // ==========================================
    
    match /guides/{guideId} {
      allow read: if isAuthenticated();
      allow create, update: if isManager();
      allow delete: if false;
      
      // Shifts subcollection
      match /shifts/{shiftId} {
        allow read: if isManager() || 
                       (isGuide() && guideId == request.auth.token.guideId);
        allow write: if isManager() || 
                        (isGuide() && guideId == request.auth.token.guideId);
      }
    }
    
    // ==========================================
    // VENDORS COLLECTION
    // ==========================================
    
    match /vendors/{vendorId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isManager();
    }
    
    // ==========================================
    // VENDOR_COSTS COLLECTION
    // ==========================================
    
    match /vendor_costs/{vendorCostId} {
      allow read: if isManager() || 
                     (isGuide() && resource.data.guideId == request.auth.token.guideId);
      
      allow create: if isManager() || 
                       (isGuide() && request.resource.data.guideId == request.auth.token.guideId);
      
      allow update: if isManager() ||
                       (isGuide() && 
                        resource.data.guideId == request.auth.token.guideId &&
                        request.time < resource.data.createdAt + duration.value(1, 'd'));
      
      allow delete: if false;
    }
    
       // ==========================================
    // GUIDE_INVOICES COLLECTION
    // Manager edita todo; guía solo ciertos campos de su propia factura
    // ==========================================

    match /guide_invoices/{invoiceId} {
      // Manager puede leer todo; guía solo su propia factura
      allow read: if isManager() ||
                   (isGuide() && resource.data.guideId == request.auth.token.guideId);

      // La creación/borrado de reportes la hace SOLO backend (Cloud Functions)
      allow create, delete: if false;

      // Actualización:
      // - Guía: solo su propia factura y solo campos relacionados con su flujo
      // - Manager: puede actualizar cualquier campo necesario (tours, salarios, etc.)
      allow update: if
        (
          isGuide() &&
          resource.data.guideId == request.auth.token.guideId &&
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly([
              'status',
              'guideApprovedReportAt',
              'uploadDeadline',
              'rejectionComments',
              'rejectedAt',
              'officialInvoicePdfUrl',
              'officialInvoiceNumber',
              'officialInvoiceUploadedAt',
              'updatedAt'
            ])
        )
        ||
        (
          isManager() &&
          (
            resource.data.status == 'MANAGER_REVIEW' ||
            resource.data.status == 'REJECTED' ||
            resource.data.status == 'PENDING_GUIDE_APPROVAL' ||
            resource.data.status == 'PENDING_MANAGER_VERIFICATION'
          )
        );
    }

    
    // ==========================================
    // VENDOR_REPORTS COLLECTION
    // ==========================================
    
    match /vendor_reports/{reportId} {
      allow read: if isManager();
      allow write: if false;
    }
    
    // ==========================================
    // BOOKEO_BLOCKS COLLECTION
    // ==========================================
    
    match /bookeo_blocks/{blockId} {
      allow read: if isAuthenticated();
      allow write: if false; // Solo Cloud Functions
    }
    
    // ==========================================
    // BOOKEO_EMAIL_STATE COLLECTION
    // ==========================================
    
    match /bookeo_email_state/{stateId} {
      allow read: if isManager();
      allow write: if false; // Solo Cloud Functions
    }
    
    // ==========================================
    // CONFIG COLLECTION
    // ==========================================
    
    match /config/{docId} {
      allow read: if isAuthenticated();
      allow write: if isManager();
    }
    
    // ==========================================
    // SYSTEM_LOCKS COLLECTION
    // ==========================================
    
    match /system_locks/{lockId} {
      allow read: if isManager();
      allow write: if false; // Solo Cloud Functions
    }
  }
}